<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=7,IE=9,IE=10">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>StreamLayer using ArcGIS API for JavaScript and ArcGIS GeoEvent Processor for Server</title>
    <link rel="stylesheet" href="http://js.arcgis.com/3.6/js/dojo/dijit/themes/tundra/tundra.css">
    <link rel="stylesheet" href="http://js.arcgis.com/3.6/js/esri/css/esri.css">
    <style type="text/css">
      html, body {
        height: 100%; width: 100%;
        margin: 0; padding: 0;
      }
      body{
        background-color: #fff; overflow:hidden;
        font-family: sans-serif;
      }
      #map {
        width: 100%;
        height: 100%;
      }

    </style>
    <script src="http://js.arcgis.com/3.6/"></script>
  </head>
  <body class="tundra">
      <div id="map"></div>
  </body>

  <script>
      //var curTime = new Date();
      //var curTimeStamp = Date.parse(curTime.toUTCString());
      var layerDefinition = {
          "geometryType": "esriGeometryPoint",
          "hasLiveData": true,
          "fields": [
          {
            name: "ObjectId",
            type: "esriFieldTypeOID",
            alias: "ObjectId"
          },
          {
            name: "DateStamp",
            type: "esriFieldTypeDate",
            alias: "DateStamp"
          },
          {
            name: "link",
            type: "esriFieldTypeString",
            alias: "link"
          },
          {
            name: "username",
            type: "esriFieldTypeString",
            alias: "username"
          }
        ]
      };

      var map, featureCollection, streamLayer;

      require(["esri/map",
        //"esri/TimeExtent",
        "esri/layers/StreamLayer",
        "esri/InfoTemplate",
        "esri/symbols/PictureMarkerSymbol",
        //"esri/symbols/SimpleLineSymbol",
        //"esri/renderers/SimpleRenderer",
        //"esri/renderers/TimeClassBreaksAger",
        //"esri/renderers/TemporalRenderer",
        //"dojo/_base/Color",
        //"dojo/dom",
        //"dojo/on",
        //"dojo/domReady!"
      ], function(Map, StreamLayer, InfoTemplate, PictureMarkerSymbol){
          map = new Map("map",{
            basemap: "gray",
            center: [-30.402, 45.642],
            zoom: 3 
          });
          map.infoWindow.resize(330,330);

          makeNewStreamLayer();

          // event listeners for button clicks
          //on(dom.byId("cmdNewStream"), "click", makeNewStreamLayer);
          //on(dom.byId("cmdDisconnect"), "click", disconnectStreamLayer);

          function makeStreamLayer(){
            featureCollection = {
            "layerDefinition": null,
            "featureSet": {
              "features": [],
              "geometryType": "esriGeometryPoint"}
            };
            featureCollection.layerDefinition = layerDefinition;
            var layer = new StreamLayer(featureCollection, {
              socketUrl: "ws://88.190.45.92:6180/instaws",
              purgeOptions: { displayCount: 1000 },
              trackIdField: "Link",
              infoTemplate: new InfoTemplate("Published by ${Username}", "<a href=${Link} target=_blank><img src=${Link}media ></a>")
            });

            layer.on("message", processMessage);

            return layer;
          }

          function processMessage(message){
            var miniPicture = new PictureMarkerSymbol(message.graphic.attributes["Link"]+"media", 30, 30);
            message.graphic.setSymbol(miniPicture);
            console.log(message.graphic.geometry)

          }

          function makeNewStreamLayer(){
            disconnectStreamLayer();
            streamLayer = makeStreamLayer();
            map.addLayer( streamLayer );
          }

          function disconnectStreamLayer(){
            if (streamLayer){
              streamLayer.suspend();
              streamLayer.disconnect();
              streamLayer.clear();
              map.removeLayer(streamLayer);
              streamLayer = null;
            }
          }
        });

  </script>

</html> 